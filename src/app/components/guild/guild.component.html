<div class="guild-page" *ngIf="!isLoading; else loading">
  
  <!-- Header -->
  <div class="guild-header">
    <div class="flex items-center justify-between">
      <h1 class="page-title">
        <i class="fas fa-shield-alt mr-3"></i>
        Ma Guilde
      </h1>
    </div>
  </div>

  

  <!-- Si l'utilisateur n'a pas de guilde -->
  <div *ngIf="!guild && !isCreatingGuild" class="no-guild">
    <div class="no-guild-card">
      <div class="no-guild-icon">
        <i class="fas fa-shield-alt"></i>
      </div>
      <h2>Vous n'avez pas encore de guilde</h2>
      <p>Cr√©ez votre propre guilde et invitez d'autres joueurs √† vous rejoindre !</p>
      
      <!-- ‚úÖ Affichage conditionnel selon le statut Premium -->
      <div *ngIf="canCreateGuild(); else needPremium">
        <button class="create-guild-btn" (click)="showCreateForm()">
          <i class="fas fa-plus mr-2"></i>
          Cr√©er ma guilde
        </button>
      </div>
      
      <!-- ‚úÖ Template si Premium requis -->
      <ng-template #needPremium>
        <div class="premium-required">
          <p class="premium-message">
            <i class="fas fa-crown mr-2"></i>
            La cr√©ation de guilde n√©cessite un abonnement Premium
          </p>
          
          <!-- ‚úÖ NOUVEAU : M√™me structure que le bouton logout -->
          <button class="upgrade-btn" (click)="upgradeToPremium()" [disabled]="isUpgrading">
            <!-- Animation de chargement -->
            <div *ngIf="isUpgrading" class="upgrade-loading">
              <div class="upgrade-spinner"></div>
            </div>
            
            <!-- √âtat normal -->
            <div *ngIf="!isUpgrading" class="upgrade-content">
              <i class="fas fa-crown upgrade-icon"></i>
              <span class="upgrade-text">Passer au Premium</span>
            </div>
          </button>
        </div>
      </ng-template>
    </div>
  </div>

  <!-- Formulaire de cr√©ation de guilde -->
  <div *ngIf="isCreatingGuild" class="create-guild-form">
    <div class="form-card">
      <h2>
        <i class="fas fa-plus-circle mr-3"></i>
        Cr√©er une nouvelle guilde
      </h2>
      
      <form (ngSubmit)="createGuild()" class="guild-form">
        <div class="form-group">
          <label for="guild-name">Nom de la guilde *</label>
          <input 
            type="text" 
            id="guild-name"
            [(ngModel)]="newGuild.name"
            name="guildName"
            placeholder="Entrez le nom de votre guilde"
            maxlength="50"
            [disabled]="isSubmitting"
            required>
        </div>

        <div class="form-group">
          <label for="guild-description">Description</label>
          <textarea 
            id="guild-description"
            [(ngModel)]="newGuild.description"
            name="guildDescription"
            placeholder="D√©crivez votre guilde..."
            rows="4"
            [disabled]="isSubmitting"
            maxlength="500"></textarea>
        </div>

        <div class="form-info">
          <p>
            <i class="fas fa-info-circle mr-2"></i>
            Date de cr√©ation : <strong>{{ currentDate }}</strong>
          </p>
        </div>

        <div class="form-actions">
          <button type="button" class="cancel-btn" (click)="cancelCreate()" [disabled]="isSubmitting">
            Annuler
          </button>
          <button type="submit" class="submit-btn" [disabled]="!newGuild.name.trim() || isSubmitting">
            <i *ngIf="!isSubmitting" class="fas fa-check mr-2"></i>
            <i *ngIf="isSubmitting" class="fas fa-spinner fa-spin mr-2"></i>
            {{ isSubmitting ? 'Cr√©ation...' : 'Cr√©er la guilde' }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Affichage de la guilde existante -->
  <div *ngIf="guild && !isCreatingGuild" class="guild-info">
    <div class="guild-card">
      <div class="guild-header-info">
        <div class="guild-icon">
          <i class="fas fa-shield-alt"></i>
        </div>
        <div class="guild-details">
          <div class="guild-title-row">
            <h2>{{ guild.name }}</h2>
            <!-- ‚úÖ NOUVEAU : Badge propri√©taire d√©plac√© ici -->
            <div *ngIf="guild && isGuildOwner" class="owner-badge-compact">
              <div class="owner-content">
                <i class="fas fa-crown"></i>
                <span class="owner-text">Propri√©taire</span>
              </div>
            </div>
          </div>
          <p class="guild-description">{{ guild.description || 'Aucune description' }}</p>
        </div>
      </div>

      <div class="guild-stats">
        <div class="stat-item">
          <i class="fas fa-users"></i>
          <span>{{ guild.member_count || 1 }}/{{ guild.max_members || 50 }} membres</span>
        </div>
        <div class="stat-item">
          <i class="fas fa-calendar-alt"></i>
          <span>Cr√©√©e le {{ guild.created_at | date:'dd/MM/yyyy' }}</span>
        </div>
      </div>

      <div class="guild-actions">
        <button 
          class="action-btn" 
          (click)="toggleInvitations()"
          [disabled]="!isGuildOwner">
          <i class="fas fa-user-plus mr-2"></i>
          <span *ngIf="!showInvitations">Inviter des membres</span>
          <span *ngIf="showInvitations">Masquer les invitations</span>
        </button>
        
        <button 
          class="action-btn" 
          (click)="showGuildSettings()"
          [disabled]="!isGuildOwner">
          <i class="fas fa-cog mr-2"></i>
          Param√®tres
        </button>

        <!-- ‚úÖ BOUTON pour quitter la guilde (membres) -->
        <button 
          class="action-btn danger-btn" 
          (click)="leaveGuild()"
          [disabled]="isSubmitting || isGuildOwner"
          *ngIf="guild && !isGuildOwner">
          <i class="fas fa-sign-out-alt mr-2"></i>
          <span *ngIf="!isSubmitting">Quitter la guilde</span>
          <span *ngIf="isSubmitting">
            <i class="fas fa-spinner fa-spin mr-2"></i>
            Sortie en cours...
          </span>
        </button>

        <!-- ‚úÖ NOUVEAU BOUTON pour dissoudre la guilde (propri√©taire uniquement) -->
        <button 
          class="action-btn disband-btn" 
          (click)="disbandGuild()"
          [disabled]="isSubmitting || !isGuildOwner"
          *ngIf="guild && isGuildOwner">
          <i class="fas fa-skull-crossbones mr-2"></i>
          <span *ngIf="!isSubmitting">Dissoudre la guilde</span>
          <span *ngIf="isSubmitting">
            <i class="fas fa-spinner fa-spin mr-2"></i>
            Dissolution en cours...
          </span>
        </button>
      </div>
    </div>

    <!-- ‚úÖ AJOUTER cette section dans ton template existant, apr√®s les infos de guilde -->

    <!-- Section Invitations (seulement pour le propri√©taire) -->
    <div class="guild-invitations" *ngIf="guild && isGuildOwner && showInvitations">
      <div class="invitation-card">
        <div class="invitation-header">
          <div class="header-content">
            <i class="fas fa-link"></i>
            <h3>üîó Gestion des invitations</h3>
          </div>
          <button 
            (click)="toggleInvitations()" 
            class="close-btn">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <!-- Formulaire cr√©ation invitation -->
        <div class="create-invitation-section">
          <h4>üìù Cr√©er une nouvelle invitation</h4>
          <div class="invitation-form">
            <div class="form-row">
              <div class="form-group">
                <label>Nombre max d'utilisations</label>
                <input 
                  type="number" 
                  [(ngModel)]="invitationForm.maxUses"
                  placeholder="Illimit√©"
                  min="1" 
                  max="100"
                  class="form-input">
              </div>
              <div class="form-group">
                <label>Expire dans (heures)</label>
                <input 
                  type="number" 
                  [(ngModel)]="invitationForm.expiresInHours"
                  placeholder="Jamais"
                  min="1" 
                  max="168"
                  class="form-input">
              </div>
              <div class="form-group">
                <button 
                  (click)="createInvitation()" 
                  class="create-btn"
                  [disabled]="isCreatingInvitation">
                  <i *ngIf="isCreatingInvitation" class="fas fa-spinner fa-spin"></i>
                  <i *ngIf="!isCreatingInvitation" class="fas fa-plus"></i>
                  {{ isCreatingInvitation ? 'Cr√©ation...' : 'Cr√©er' }}
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Loading invitations -->
        <div *ngIf="isLoadingInvitations" class="loading-section">
          <div class="loading-spinner"></div>
          <p>Chargement des invitations...</p>
        </div>

        <!-- Liste des invitations -->
        <div class="invitations-list" *ngIf="!isLoadingInvitations">
          <div class="list-header">
            <h4>üìã Invitations actives ({{ invitations.length }})</h4>
            
            <!-- ‚úÖ Bouton de nettoyage global si il y a des invitations inactives -->
            <div class="header-actions" *ngIf="getInactiveInvitationsCount() > 0">
              <button 
                (click)="cleanupInactiveInvitations()" 
                class="cleanup-btn"
                title="Supprimer toutes les invitations inactives d'un coup">
                <i class="fas fa-broom"></i>
                Nettoyer ({{ getInactiveInvitationsCount() }})
              </button>
            </div>
          </div>
          
          <div class="no-invitations" *ngIf="invitations.length === 0">
            <div class="empty-state">
              <i class="fas fa-envelope-open"></i>
              <p>Aucune invitation cr√©√©e</p>
              <span>Cr√©ez votre premi√®re invitation pour inviter des membres !</span>
            </div>
          </div>

          <div class="invitation-item" *ngFor="let invitation of invitations; trackBy: trackByInvitationId">
            <div class="invitation-content">
              
              <!-- Info principale -->
              <div class="invitation-main">
                <div class="invitation-code">
                  <label>Code d'invitation</label>
                  <div class="code-display">
                    <code>{{ invitation.code }}</code>
                    <button 
                      (click)="copyToClipboard(invitation.code)" 
                      class="copy-btn-small"
                      title="Copier le code">
                      <i class="fas fa-copy"></i>
                    </button>
                  </div>
                </div>
                
                <div class="invitation-url">
                  <label>Lien d'invitation</label>
                  <div class="url-container">
                    <input 
                      readonly 
                      [value]="invitation.url" 
                      class="url-input"
                      #urlInput>
                    <button 
                      (click)="copyToClipboard(invitation.url)" 
                      class="copy-btn"
                      title="Copier le lien">
                      <i class="fas fa-copy"></i>
                      Copier
                    </button>
                  </div>
                </div>
              </div>

              <!-- Stats et statut -->
              <div class="invitation-meta">
                <div class="invitation-stats">
                  <div class="stat" *ngIf="invitation.max_uses">
                    <i class="fas fa-users"></i>
                    <span>{{ invitation.uses_count }}/{{ invitation.max_uses }}</span>
                  </div>
                  <div class="stat" *ngIf="!invitation.max_uses">
                    <i class="fas fa-infinity"></i>
                    <span>{{ invitation.uses_count }} utilisations</span>
                  </div>
                  <div class="stat" *ngIf="invitation.expires_at">
                    <i class="fas fa-clock"></i>
                    <span>{{ invitation.expires_at | date:'dd/MM/yyyy HH:mm' }}</span>
                  </div>
                  <div class="stat">
                    <span 
                      class="status-badge"
                      [ngClass]="{
                        'status-valid': invitation.is_valid && invitation.is_active,
                        'status-invalid': !invitation.is_valid || !invitation.is_active
                      }">
                      <i class="fas" 
                         [ngClass]="{
                           'fa-check-circle': invitation.is_valid && invitation.is_active,
                           'fa-times-circle': !invitation.is_valid || !invitation.is_active
                         }"></i>
                      {{ (invitation.is_valid && invitation.is_active) ? 'Active' : 'Inactive' }}
                    </span>
                  </div>
                </div>

                <!-- Actions -->
                <div class="invitation-actions">
                  <!-- Bouton d√©sactiver pour les invitations actives -->
                  <button 
                    *ngIf="invitation.is_active && invitation.is_valid"
                    (click)="deactivateInvitation(invitation.id)" 
                    class="deactivate-btn"
                    title="D√©sactiver cette invitation (elle restera mais ne fonctionnera plus)">
                    <i class="fas fa-pause"></i>
                    D√©sactiver
                  </button>
                  
                  <!-- ‚úÖ Bouton supprimer SEULEMENT pour les invitations inactives -->
                  <button 
                    *ngIf="!invitation.is_active || !invitation.is_valid"
                    (click)="deleteInvitation(invitation.id)" 
                    class="delete-btn"
                    title="Supprimer d√©finitivement cette invitation">
                    <i class="fas fa-trash"></i>
                    Supprimer
                  </button>
                  
                  <!-- Texte pour les invitations d√©sactiv√©es -->
                  <span *ngIf="(!invitation.is_active || !invitation.is_valid)" 
                        class="disabled-text">
                    <i class="fas fa-ban"></i>
                    Invitation d√©sactiv√©e
                  </span>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ AJOUTER un message si pas propri√©taire -->
  <div *ngIf="guild && !isGuildOwner" class="info-message">
    <i class="fas fa-info-circle mr-2"></i>
    Seul le propri√©taire de la guilde peut inviter des membres et g√©rer les param√®tres.
  </div>
</div>

<!-- Loading template -->
<ng-template #loading>
  <div class="loading-container">
    <div class="loading-spinner"></div>
    <p>Chargement des informations de guilde...</p>
  </div>
</ng-template>
