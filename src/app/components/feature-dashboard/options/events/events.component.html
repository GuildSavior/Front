<div class="events-page" *ngIf="!isLoading; else loading">
  
  <!-- Header -->
  <div class="events-header">
    <div class="header-content">
      <h1>üéØ √âv√©nements de guilde</h1>
      <p *ngIf="guild" class="guild-info">{{ guild.name }}</p>
    </div>
    
    <!-- Bouton cr√©er √©v√©nement (owner seulement) -->
    <div class="header-actions" *ngIf="isGuildOwner">
      <button 
        class="create-event-btn" 
        (click)="showCreateEventForm()"
        [disabled]="showCreateForm">
        <i class="fas fa-plus mr-2"></i>
        Cr√©er un √©v√©nement
      </button>
    </div>
  </div>

  <!-- Messages -->
  <div *ngIf="errorMessage" class="alert alert-error">
    <i class="fas fa-exclamation-triangle mr-2"></i>
    {{ errorMessage }}
  </div>

  <div *ngIf="successMessage" class="alert alert-success">
    <i class="fas fa-check-circle mr-2"></i>
    {{ successMessage }}
  </div>

  <!-- Formulaire cr√©ation √©v√©nement -->
  <div *ngIf="showCreateForm" class="create-event-form">
    <div class="form-card">
      <div class="form-header">
        <h3>üìÖ Cr√©er un nouvel √©v√©nement</h3>
        <button class="close-btn" (click)="cancelCreateEvent()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <form (ngSubmit)="createEvent()" #eventFormRef="ngForm">
        <div class="form-row">
          <div class="form-group">
            <label for="event-name">Nom de l'√©v√©nement *</label>
            <input 
              type="text" 
              id="event-name"
              class="form-input"
              [(ngModel)]="eventForm.name"
              name="name"
              placeholder="Ex: Raid Donjon des Flammes"
              required
              maxlength="255">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="event-description">Description</label>
            <textarea 
              id="event-description"
              class="form-textarea"
              [(ngModel)]="eventForm.description"
              name="description"
              placeholder="D√©tails de l'√©v√©nement..."
              rows="3"
              maxlength="1000"></textarea>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="event-start">D√©but *</label>
            <input 
              type="datetime-local" 
              id="event-start"
              class="form-input"
              [(ngModel)]="eventForm.start_time"
              name="start_time"
              required>
          </div>
          
          <div class="form-group">
            <label for="event-end">Fin *</label>
            <input 
              type="datetime-local" 
              id="event-end"
              class="form-input"
              [(ngModel)]="eventForm.end_time"
              name="end_time"
              required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="dkp-reward">R√©compense DKP *</label>
            <input 
              type="number" 
              id="dkp-reward"
              class="form-input"
              [(ngModel)]="eventForm.dkp_reward"
              name="dkp_reward"
              min="1"
              max="1000"
              required>
          </div>
        </div>

        <div class="form-actions">
          <button 
            type="button" 
            class="btn-secondary" 
            (click)="cancelCreateEvent()"
            [disabled]="isSubmitting">
            Annuler
          </button>
          
          <button 
            type="submit" 
            class="btn-primary"
            [disabled]="isSubmitting || !eventFormRef.form.valid">
            <i *ngIf="isSubmitting" class="fas fa-spinner fa-spin mr-2"></i>
            <i *ngIf="!isSubmitting" class="fas fa-calendar-plus mr-2"></i>
            {{ isSubmitting ? 'Cr√©ation...' : 'Cr√©er l\'√©v√©nement' }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Liste des √©v√©nements -->
  <div class="events-section">
    <!-- Loading √©v√©nements -->
    <div *ngIf="isLoadingEvents" class="loading-events">
      <div class="loading-spinner"></div>
      <p>Chargement des √©v√©nements...</p>
    </div>

    <!-- Aucun √©v√©nement -->
    <div *ngIf="!isLoadingEvents && events.length === 0" class="no-guild">
      <div class="no-guild-card">
        <div class="no-guild-icon">
          <i class="fas fa-calendar-times"></i>
        </div>
        <h2>Aucun √©v√©nement</h2>
        <p>Il n'y a aucun √©v√©nement planifi√© dans votre guilde pour le moment.</p>
        
        <div *ngIf="isGuildOwner">
          <button class="create-guild-btn" (click)="showCreateEventForm()">
            <i class="fas fa-plus mr-2"></i>
            Cr√©er le premier √©v√©nement
          </button>
        </div>
      </div>
    </div>

    <!-- Liste des √©v√©nements -->
    <div *ngIf="!isLoadingEvents && events.length > 0" class="events-list">
      <div 
        *ngFor="let event of events" 
        class="event-card"
        [class]="'event-' + event.status">
        
        <!-- Header de l'√©v√©nement -->
        <div class="event-header">
          <div class="event-info">
            <h3 class="event-title">{{ event.name }}</h3>
            <p *ngIf="event.description" class="event-description">{{ event.description }}</p>
          </div>
          
          <div class="event-status">
            <span class="status-badge" [class]="'status-' + event.status">
              <i class="fas" [class]="getEventStatusIcon(event)"></i>
              {{ getEventStatusText(event) }}
            </span>
          </div>
        </div>

        <!-- D√©tails de l'√©v√©nement -->
        <div class="event-details">
          <div class="detail-item">
            <i class="fas fa-clock"></i>
            <span>{{ event.start_time | date:'dd/MM/yyyy HH:mm' }} - {{ event.end_time | date:'dd/MM/yyyy HH:mm' }}</span>
          </div>
          
          <div class="detail-item">
            <i class="fas fa-coins"></i>
            <span>{{ event.dkp_reward }} DKP</span>
          </div>
          
          <div class="detail-item">
            <i class="fas fa-users"></i>
            <span>{{ event.participant_count }} participant(s) ‚Ä¢ {{ event.confirmed_count }} confirm√©(s) ‚Ä¢ {{ event.attended_count }} pr√©sent(s)</span>
          </div>

          <!-- Code d'acc√®s (owner seulement) -->
          <div *ngIf="isGuildOwner && event.access_code" class="detail-item access-code">
            <i class="fas fa-key"></i>
            <span>Code d'acc√®s: </span>
            <code class="access-code-value">{{ event.access_code }}</code>
            <button 
              class="copy-btn" 
              (click)="copyAccessCode(event)"
              title="Copier le code">
              <i class="fas fa-copy"></i>
            </button>
          </div>
        </div>

        <!-- Statut participation utilisateur -->
        <div class="user-participation">
          <div class="participation-status">
            <i class="fas" [class]="getUserParticipationIcon(event)"></i>
            <span>{{ getUserParticipationText(event) }}</span>
            <span *ngIf="(event.user_participation?.dkp_earned ?? 0) > 0" 
                  class="dkp-earned">
              (+{{ event.user_participation?.dkp_earned ?? 0 }} DKP)
            </span>
          </div>
        </div>

        <!-- Actions de l'√©v√©nement -->
        <div class="event-actions">
          <!-- S'inscrire -->
          <button 
            *ngIf="getUserParticipationStatus(event) === 'not_participating' && event.status !== 'finished'"
            class="btn-action btn-participate"
            (click)="participateInEvent(event)">
            <i class="fas fa-user-plus mr-2"></i>
            S'inscrire
          </button>

          <!-- Confirmer venue -->
          <button 
            *ngIf="getUserParticipationStatus(event) === 'interested' && event.status !== 'finished'"
            class="btn-action btn-confirm"
            (click)="confirmParticipation(event)">
            <i class="fas fa-check mr-2"></i>
            Confirmer ma venue
          </button>

          <!-- Valider pr√©sence -->
          <button 
            *ngIf="getUserParticipationStatus(event) === 'confirmed' && (event.status === 'ongoing' || event.status === 'finished')"
            class="btn-action btn-validate"
            (click)="openValidationModal(event)">
            <i class="fas fa-medal mr-2"></i>
            Valider ma pr√©sence
          </button>

          <!-- D√©j√† valid√© -->
          <div 
            *ngIf="getUserParticipationStatus(event) === 'attended'"
            class="participation-validated">
            <i class="fas fa-medal mr-2"></i>
            Pr√©sence valid√©e
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal validation pr√©sence -->
<div *ngIf="showValidationModal" class="modal-overlay" (click)="closeValidationModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>üéØ Valider ma pr√©sence</h3>
      <button class="close-btn" (click)="closeValidationModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <p *ngIf="selectedEvent">
        Entrez le code d'acc√®s fourni par l'organisateur de l'√©v√©nement 
        <strong>"{{ selectedEvent.name }}"</strong> pour valider votre pr√©sence et recevoir vos DKP.
      </p>
      
      <div class="form-group">
        <label for="validation-code">Code d'acc√®s</label>
        <input 
          type="text" 
          id="validation-code"
          class="form-input"
          [(ngModel)]="validationForm.code"
          placeholder="Entrez le code..."
          maxlength="8"
          style="text-transform: uppercase;">
      </div>
      
      <div *ngIf="errorMessage" class="alert alert-error">
        <i class="fas fa-exclamation-triangle mr-2"></i>
        {{ errorMessage }}
      </div>
    </div>
    
    <div class="modal-actions">
      <button 
        type="button" 
        class="btn-secondary" 
        (click)="closeValidationModal()"
        [disabled]="isSubmitting">
        Annuler
      </button>
      
      <button 
        type="button" 
        class="btn-primary"
        (click)="validateAttendance()"
        [disabled]="isSubmitting || !validationForm.code.trim()">
        <i *ngIf="isSubmitting" class="fas fa-spinner fa-spin mr-2"></i>
        <i *ngIf="!isSubmitting" class="fas fa-check mr-2"></i>
        {{ isSubmitting ? 'Validation...' : 'Valider' }}
      </button>
    </div>
  </div>
</div>

<!-- Template loading -->
<ng-template #loading>
  <div class="loading-container">
    <div class="loading-spinner"></div>
    <p>Chargement...</p>
  </div>
</ng-template>

<!-- Message si pas de guilde -->
<div *ngIf="!isLoading && !guild" class="no-guild">
  <div class="no-guild-card">
    <div class="no-guild-icon">
      <i class="fas fa-shield-alt"></i>
    </div>
    <h2>Aucune guilde</h2>
    <p>Vous devez √™tre membre d'une guilde pour voir les √©v√©nements.</p>
    
    <div>
      <button class="create-guild-btn" (click)="goToDashboard()">
        <i class="fas fa-arrow-left mr-2"></i>
        Retour au tableau de bord
      </button>
    </div>
  </div>
</div>
