<!-- Si user est d√©fini, on affiche les infos -->
<div class="dashboard" *ngIf="!isLoading && user; else loading">
  <div class="dashboard-container">
    <!-- Colonne Infos Utilisateur -->
    <section class="user-info">
      <div class="avatar-block">
        <img [src]="user.avatar" alt="Avatar" class="avatar" />
        <div class="user-basic">
          <h2>{{ user.username }}</h2>
          <button class="show-sensitive-btn" (click)="showSensitive = !showSensitive">
            {{ showSensitive ? 'Masquer' : 'Afficher les infos sensibles' }}
          </button>
          <div 
            class="sensitive-info" 
            *ngIf="showSensitive"
            [@fadeSlide]>
            <p class="user-email">{{ user.email }}</p>
            <p class="user-id">ID Discord : {{ user.discord_id }}</p>
          </div>
        </div>
      </div>
      
      <!-- Statut Premium -->
      <div class="premium-status" [ngClass]="getPremiumBadgeClass()">
        <div *ngIf="isPremium()" class="premium-badge premium-active">
          <i class="fas fa-crown"></i>
          <div class="premium-info">
            <span class="premium-label">Premium</span>
            <span class="premium-expiry">Expire le {{ getSubscriptionInfo()?.formattedExpiry }}</span>
          </div>
        </div>
        
        <div *ngIf="!isPremium()" class="premium-badge premium-none">
          <i class="fas fa-star"></i>
          <div class="premium-info">
            <span class="premium-label">Free</span>
            <span class="premium-upgrade">Passez au Premium</span>
          </div>
        </div>
      </div>

      <!-- ‚úÖ SECTION FUSIONN√âE: Profil de personnage -->
      <div class="player-profile-section">
        <div class="profile-header">
          <h4>üó°Ô∏è Mon Personnage & Statistiques</h4>
        </div>
        
        <!-- ‚úÖ BOUTONS SUR UNE LIGNE S√âPAR√âE -->
        <div class="profile-actions" *ngIf="hasPlayerProfile && !isEditingPlayer">
          <button class="edit-btn" (click)="startEditPlayer()">
            <i class="fas fa-edit"></i>
            Modifier
          </button>
          <button class="delete-btn" (click)="deletePlayerProfile()">
            <i class="fas fa-trash"></i>
            Supprimer
          </button>
        </div>

        <!-- Affichage du profil existant -->
        <div class="player-display" *ngIf="hasPlayerProfile && !isEditingPlayer">
          <div class="player-info">
            <div class="info-row">
              <span class="label">Nom :</span>
              <span class="value">{{ currentPlayer.name }}</span>
            </div>
            <div class="info-row">
              <span class="label">Niveau :</span>
              <span class="value">{{ currentPlayer.level }}</span>
            </div>
            <div class="info-row">
              <span class="label">Classe/R√¥le :</span>
              <span class="value class-badge role-class">{{ currentPlayer.class }}</span>
            </div>
            <div class="info-row">
              <span class="label">DKP :</span>
              <span class="value dkp-value">{{ currentPlayer.dkp || 0 }}</span>
            </div>
            <div class="info-row">
              <span class="label">√âv√©nements :</span>
              <span class="value">{{ currentPlayer.events_joined || 0 }}</span>
            </div>
          </div>
        </div>

        <!-- Formulaire de cr√©ation/modification -->
        <div class="player-form" *ngIf="!hasPlayerProfile || isEditingPlayer">
          <div class="form-group">
            <label for="player-name">Nom du personnage *</label>
            <input 
              id="player-name"
              type="text" 
              [(ngModel)]="playerForm.name"
              placeholder="Ex: Legolas"
              maxlength="50"
              class="form-input">
          </div>

          <div class="form-group">
            <label for="player-level">Niveau *</label>
            <input 
              id="player-level"
              type="number" 
              [(ngModel)]="playerForm.level"
              min="1" 
              max="100"
              class="form-input">
          </div>

          <!-- ‚úÖ MODIFI√â: Select pour le r√¥le qui devient la classe -->
          <div class="form-group">
            <label for="player-class">R√¥le/Classe *</label>
            <select 
              id="player-class"
              [(ngModel)]="playerForm.class"
              class="form-select">
              <option value="tank">üõ°Ô∏è Tank</option>
              <option value="dps">‚öîÔ∏è DPS</option>
              <option value="support">ü©π Support</option>
              <option value="range">üèπ Range</option>
              <option value="mage">üîÆ Mage</option>
            </select>
          </div>

          <div class="form-actions">
            <button 
              class="save-btn"
              (click)="savePlayerProfile()"
              [disabled]="isSubmittingPlayer || !playerForm.name.trim()">
              <i *ngIf="!isSubmittingPlayer" class="fas fa-save"></i>
              <i *ngIf="isSubmittingPlayer" class="fas fa-spinner fa-spin"></i>
              {{ isSubmittingPlayer ? 'Sauvegarde...' : (hasPlayerProfile ? 'Mettre √† jour' : 'Cr√©er profil') }}
            </button>
            
            <button 
              *ngIf="isEditingPlayer"
              class="cancel-btn"
              (click)="cancelEditPlayer()">
              <i class="fas fa-times"></i>
              Annuler
            </button>
          </div>
        </div>

        <!-- Message d'aide -->
        <div class="help-text" *ngIf="!hasPlayerProfile && !isEditingPlayer">
          <p><i class="fas fa-info-circle"></i> Cr√©ez votre profil de personnage WoW pour suivre vos DKP et √©v√©nements.</p>
          <button class="create-profile-btn" (click)="isEditingPlayer = true">
            <i class="fas fa-plus"></i>
            Cr√©er mon profil
          </button>
        </div>
      </div>
    </section>

    <!-- Colonne Actions/Stats -->
    <section class="user-actions">
      <h3>Actions rapides</h3>
      <button class="dashboard-btn" (click)="goToGuild()">Voir ma guilde</button>

    </section>
  </div>
</div>

<!-- Template de fallback pendant le chargement -->
<ng-template #loading>
  <div class="loading-container">
    <div class="loading-spinner"></div>
    <h3>Chargement de votre dashboard...</h3>
    <p>Veuillez patienter...</p>
  </div>
</ng-template>

<!-- Notification en bas √† droite -->
<div *ngIf="notification" class="dashboard-notification">
  {{ notification }}
</div>
